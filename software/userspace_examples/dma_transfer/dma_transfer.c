#include "dma_transfer_common.h"


//////////////////////////////////////////////////////////////////
//
// Main
//
///////////////////////////////////////////////////////////////

int main()
{
	unsigned int i;
	int xStatus;
	char c;
	printf("app start...\n\r");

	///////////////////////////////////////////////////////////////
    //
    // create a thread for interrupt handler
    //
    ///////////////////////////////////////////////////////////////

	pthread_t thread_id;
	pthread_create(&thread_id, NULL, interrupt_handler, NULL);

	///////////////////////////////////////////////////////////////
    //
    // map memory for PL Device registers and DDR Buffers
    //
    ///////////////////////////////////////////////////////////////

	xStatus = device_init();
	if(xStatus == 0){
		printf("device mmap successfull\n");
	}
	else{
		return -1;
	}

	///////////////////////////////////////////////////////////////
    //
    // read input data from binary file
    //
    ///////////////////////////////////////////////////////////////

	read_file();

    ///////////////////////////////////////////////////////////////
    //
    // fill up MM2S Buffers
    //
    ///////////////////////////////////////////////////////////////

	for (i = 0; i < TRANSFER_SIZE ; i++ )  {
		dma_mm2s_buffer_int[i] = 40 + i;
		dma_mm2s_buffer_int[i+TRANSFER_SIZE] = 1;
	}

    ///////////////////////////////////////////////////////////////
    //
    // Run DMAs
    //
    ///////////////////////////////////////////////////////////////

	DMA_Init ();
	DMA_S2MM_Start_Transfer();
	DMA_MM2S_Start_Transfer();

    ///////////////////////////////////////////////////////////////
    //
    // print dma outputs
    //
    ///////////////////////////////////////////////////////////////

	printf("DMA S2MM Buffer:\n\r");
	printf("index:\t\tsource\t\tresult\n\r");
	for (i = 0; i < TRANSFER_SIZE; i++)
		printf("%d:\t\t%d\t\t%d\n\r", i, dma_mm2s_buffer_int[i], dma_mm2s_buffer_int[i+TRANSFER_SIZE] );

    ///////////////////////////////////////////////////////////////
    //
    // write outputs to binary file
    //
    ///////////////////////////////////////////////////////////////

	write_file();

	return 0;
}
